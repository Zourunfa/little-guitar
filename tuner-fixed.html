<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¤åçš„å‰ä»–è°ƒéŸ³å™¨</title>
    <style>
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-top: 20px;
        }
        
        .note-display {
            text-align: center;
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 10px;
            height: 80px;
            color: #FFD700;
        }
        
        .frequency-display {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .tuning-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .tuning-center {
            position: absolute;
            height: 100%;
            width: 2px;
            background: #4CAF50;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .tuning-needle {
            position: absolute;
            height: 100%;
            width: 4px;
            background: white;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.3s ease;
            border-radius: 2px;
        }
        
        .accuracy-display {
            text-align: center;
            font-size: 1.2rem;
            margin-top: 10px;
            height: 30px;
            font-weight: bold;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            text-align: center;
            margin: 15px 0;
            font-size: 1.1rem;
            min-height: 25px;
        }
        
        .debug-info {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .tuning-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9rem;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <h1>ğŸ¸ ä¿®å¤åçš„å‰ä»–è°ƒéŸ³å™¨</h1>
    
    <div class="container">
        <div class="note-display" id="noteDisplay">--</div>
        <div class="frequency-display" id="frequencyDisplay">é¢‘ç‡: -- Hz</div>
        
        <div class="tuning-bar">
            <div class="tuning-center"></div>
            <div class="tuning-needle" id="tuningNeedle"></div>
        </div>
        
        <div class="tuning-labels">
            <span>-50éŸ³åˆ†</span>
            <span>å‡†ç¡®</span>
            <span>+50éŸ³åˆ†</span>
        </div>
        
        <div class="accuracy-display" id="accuracyDisplay"></div>
        <div class="status" id="status">ç‚¹å‡»å¼€å§‹è°ƒéŸ³æŒ‰é’®</div>
        
        <div style="text-align: center;">
            <button id="startButton">å¼€å§‹è°ƒéŸ³</button>
        </div>
        
        <div class="debug-info" id="debugInfo">
            è°ƒè¯•ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
        </div>
    </div>

    <script>
        // å‰ä»–æ ‡å‡†è°ƒéŸ³é¢‘ç‡ï¼ˆHzï¼‰
        const guitarStrings = {
            '6': { note: 'E2', frequency: 82.41 }
        };
        
        // éŸ³åä¸é¢‘ç‡æ˜ å°„
        const noteFrequencies = {
            'C': 16.35, 'C#': 17.32, 'D': 18.35, 'D#': 19.45,
            'E': 20.60, 'F': 21.83, 'F#': 23.12, 'G': 24.50,
            'G#': 25.96, 'A': 27.50, 'A#': 29.14, 'B': 30.87
        };
        
        // DOMå…ƒç´ 
        const noteDisplay = document.getElementById('noteDisplay');
        const frequencyDisplay = document.getElementById('frequencyDisplay');
        const tuningNeedle = document.getElementById('tuningNeedle');
        const accuracyDisplay = document.getElementById('accuracyDisplay');
        const statusDisplay = document.getElementById('status');
        const startButton = document.getElementById('startButton');
        const debugInfo = document.getElementById('debugInfo');
        
        // çŠ¶æ€å˜é‡
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let isTuning = false;
        let selectedString = '6';
        let animationFrameId = null;
        
        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function log(message) {
            console.log(message);
            debugInfo.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        // å¼€å§‹/åœæ­¢è°ƒéŸ³
        startButton.addEventListener('click', toggleTuning);
        
        function toggleTuning() {
            if (!isTuning) {
                startTuning();
            } else {
                stopTuning();
            }
        }
        
        async function startTuning() {
            try {
                log('å¼€å§‹è°ƒéŸ³...');
                
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.mediaDevices || !window.AudioContext) {
                    statusDisplay.textContent = "æµè§ˆå™¨ä¸æ”¯æŒè°ƒéŸ³åŠŸèƒ½";
                    log('æµè§ˆå™¨ä¸æ”¯æŒå¿…è¦çš„API');
                    return;
                }
                
                // è¯·æ±‚éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        sampleRate: 44100
                    } 
                });
                
                log('éº¦å…‹é£æƒé™è·å–æˆåŠŸ');
                statusDisplay.textContent = "è°ƒéŸ³å™¨å·²å¯åŠ¨ï¼Œè¯·å¼¹å“å‰ä»–å¼¦";
                startButton.textContent = "åœæ­¢è°ƒéŸ³";
                startButton.style.background = "#f44336";
                isTuning = true;
                
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                
                // è®¾ç½®åˆ†æå™¨ - æ›´é«˜çš„FFTå¤§å°ä»¥æé«˜ç²¾åº¦
                analyser.fftSize = 32768;
                analyser.smoothingTimeConstant = 0.8;
                analyser.minDecibels = -100;
                analyser.maxDecibels = -10;
                
                microphone.connect(analyser);
                
                log(`éŸ³é¢‘ä¸Šä¸‹æ–‡åˆ›å»ºæˆåŠŸ - é‡‡æ ·ç‡: ${audioContext.sampleRate}Hz, FFTå¤§å°: ${analyser.fftSize}`);
                
                // å¼€å§‹éŸ³é¢‘å¤„ç†å¾ªç¯
                processAudio();
                
            } catch (err) {
                log(`è°ƒéŸ³å™¨å¯åŠ¨å¤±è´¥: ${err.message}`);
                statusDisplay.textContent = `é”™è¯¯: ${err.message}`;
            }
        }
        
        function stopTuning() {
            log('åœæ­¢è°ƒéŸ³...');
            
            isTuning = false;
            
            // å–æ¶ˆåŠ¨ç”»å¸§
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            if (microphone) {
                microphone.disconnect();
                microphone = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            analyser = null;
            
            statusDisplay.textContent = "è°ƒéŸ³å™¨å·²åœæ­¢";
            startButton.textContent = "å¼€å§‹è°ƒéŸ³";
            startButton.style.background = "#4CAF50";
            
            // é‡ç½®æ˜¾ç¤º
            noteDisplay.textContent = "--";
            frequencyDisplay.textContent = "é¢‘ç‡: -- Hz";
            accuracyDisplay.textContent = "";
            tuningNeedle.style.left = "50%";
            tuningNeedle.style.background = "white";
        }
        
        // å¤„ç†éŸ³é¢‘æ•°æ®
        function processAudio() {
            if (!analyser || !isTuning) return;
            
            // ä½¿ç”¨é¢‘åŸŸæ•°æ®
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Float32Array(bufferLength);
            analyser.getFloatFrequencyData(dataArray);
            
            // æ£€æŸ¥éŸ³é¢‘è¾“å…¥
            const sum = dataArray.reduce((acc, val) => acc + Math.abs(val), 0);
            const avgMagnitude = sum / bufferLength;
            
            // æ¯ç§’åªè®°å½•ä¸€æ¬¡è°ƒè¯•ä¿¡æ¯
            if (Math.random() < 0.02) { // çº¦2%çš„æ¦‚ç‡ï¼Œç›¸å½“äºæ¯ç§’å‡ æ¬¡
                log(`éŸ³é¢‘è¾“å…¥æ£€æŸ¥ - å¹³å‡å¹…åº¦: ${avgMagnitude.toFixed(2)}`);
            }
            
            // æ£€æµ‹åŸºé¢‘
            const frequency = findFundamentalFrequency(dataArray, audioContext.sampleRate);
            
            if (frequency > 0 && frequency < 1000) {
                updateDisplay(frequency);
            }
            
            // ç»§ç»­å¤„ç†éŸ³é¢‘
            if (isTuning) {
                animationFrameId = requestAnimationFrame(processAudio);
            }
        }
        
        // ä½¿ç”¨FFTé¢‘åŸŸåˆ†ææŸ¥æ‰¾åŸºé¢‘
        function findFundamentalFrequency(freqData, sampleRate) {
            const bufferLength = freqData.length;
            const nyquist = sampleRate / 2;
            
            let maxMagnitude = -Infinity;
            let peakIndex = -1;
            
            // æœç´¢å‰ä»–é¢‘ç‡èŒƒå›´ (50Hz - 500Hz)
            const minIndex = Math.floor(50 * bufferLength / nyquist);
            const maxIndex = Math.floor(500 * bufferLength / nyquist);
            
            for (let i = minIndex; i < maxIndex; i++) {
                if (freqData[i] > maxMagnitude) {
                    maxMagnitude = freqData[i];
                    peakIndex = i;
                }
            }
            
            // éœ€è¦è¶³å¤Ÿå¼ºçš„ä¿¡å·
            if (peakIndex !== -1 && maxMagnitude > -80) {
                const frequency = peakIndex * nyquist / bufferLength;
                
                // æ¯æ£€æµ‹åˆ°é¢‘ç‡æ—¶è®°å½•ä¸€æ¬¡
                if (Math.random() < 0.1) { // 10%æ¦‚ç‡è®°å½•
                    log(`æ£€æµ‹åˆ°é¢‘ç‡: ${frequency.toFixed(2)}Hz (å¹…åº¦: ${maxMagnitude.toFixed(1)}dB)`);
                }
                
                return frequency;
            }
            
            return -1;
        }
        
        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay(frequency) {
            // æ˜¾ç¤ºé¢‘ç‡
            frequencyDisplay.textContent = `é¢‘ç‡: ${frequency.toFixed(2)} Hz`;
            
            // æ‰¾åˆ°æœ€æ¥è¿‘çš„éŸ³ç¬¦
            const closestNote = findClosestNote(frequency);
            noteDisplay.textContent = closestNote.name;
            
            // è®¡ç®—ä¸ç›®æ ‡å¼¦çš„åå·®
            const targetFrequency = guitarStrings[selectedString].frequency;
            const cents = calculateCents(frequency, targetFrequency);
            
            // æ›´æ–°è°ƒéŸ³æŒ‡é’ˆ
            updateTuningNeedle(cents);
            
            // æ›´æ–°ç²¾åº¦æ˜¾ç¤º
            updateAccuracyDisplay(cents);
        }
        
        // æ‰¾åˆ°æœ€æ¥è¿‘çš„éŸ³ç¬¦
        function findClosestNote(frequency) {
            const semitonesFromC0 = 12 * Math.log2(frequency / noteFrequencies['C']);
            const octave = Math.floor(semitonesFromC0 / 12);
            const noteIndex = Math.round(semitonesFromC0 % 12);
            const noteNames = Object.keys(noteFrequencies);
            const noteName = noteNames[noteIndex];
            
            return {
                name: noteName + (octave + 1),
                frequency: noteFrequencies[noteName] * Math.pow(2, octave)
            };
        }
        
        // è®¡ç®—éŸ³åˆ†åå·®
        function calculateCents(frequency, targetFrequency) {
            return 1200 * Math.log2(frequency / targetFrequency);
        }
        
        // æ›´æ–°è°ƒéŸ³æŒ‡é’ˆ
        function updateTuningNeedle(cents) {
            const limitedCents = Math.max(-50, Math.min(50, cents));
            const position = 50 + (limitedCents / 50) * 50;
            tuningNeedle.style.left = `${position}%`;
            
            if (Math.abs(cents) < 5) {
                tuningNeedle.style.background = "#4CAF50"; // ç»¿è‰² - å‡†ç¡®
            } else if (Math.abs(cents) < 20) {
                tuningNeedle.style.background = "#FFC107"; // é»„è‰² - æ¥è¿‘
            } else {
                tuningNeedle.style.background = "#F44336"; // çº¢è‰² - åç¦»
            }
        }
        
        // æ›´æ–°ç²¾åº¦æ˜¾ç¤º
        function updateAccuracyDisplay(cents) {
            const absCents = Math.abs(cents);
            
            if (absCents < 2) {
                accuracyDisplay.textContent = "å®Œç¾!";
                accuracyDisplay.style.color = "#4CAF50";
            } else if (absCents < 5) {
                accuracyDisplay.textContent = "éå¸¸æ¥è¿‘";
                accuracyDisplay.style.color = "#8BC34A";
            } else if (absCents < 10) {
                accuracyDisplay.textContent = "æ¥è¿‘";
                accuracyDisplay.style.color = "#FFC107";
            } else if (absCents < 20) {
                accuracyDisplay.textContent = "éœ€è¦è°ƒæ•´";
                accuracyDisplay.style.color = "#FF9800";
            } else {
                accuracyDisplay.textContent = "åç¦»å¤ªå¤š";
                accuracyDisplay.style.color = "#F44336";
            }
            
            const sign = cents > 0 ? '+' : '-';
            accuracyDisplay.textContent += ` (${sign}${Math.abs(cents).toFixed(1)}éŸ³åˆ†)`;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œè°ƒéŸ³å™¨å°±ç»ª');
        });
    </script>
</body>
</html>
