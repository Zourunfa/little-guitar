# 和弦进行 - 经典音频伴奏功能完整说明

## ✅ 已实现的三大功能

### 1. 🎨 醒目的音频加载进度条

**位置**: 伴奏模式选择区域上方

**特性**:
- 🌈 **渐变色进度条**: 黄色→橙色→红色的炫酷渐变
- ✨ **动画光效**: 光带从左到右扫过的动画效果  
- 📊 **实时进度**: 大字体显示 0-100% 加载进度
- 📝 **状态提示**: 显示正在加载的调名（如"A 调加载中..."）
- ⚠️ **警告信息**: "请等待音频加载完成后再播放"

**显示时机**:
- 预加载所有音频时
- 选择新调性加载时
- 上传本地文件时

### 2. 🚫 音频未加载时禁止播放

**检查机制**:
```typescript
// 在播放前进行三重检查
1. 检查调性是否可用（isTrackAvailable）
2. 检查音频是否已预加载（isTrackPreloaded）  
3. 检查是否正在加载中（isAudioBackingLoading）
```

**用户提示**:
- ❌ 调性不可用: "X 调暂无音频文件，请选择其他调或上传本地音频！"
- ⏳ 未预加载: "X 调音频未加载，请稍候..." (自动开始加载)
- ⏳ 加载中: "音频正在加载中，请稍候..."

**自动处理**:
- 如果音频未加载，会自动触发加载流程
- 加载完成后用户可以再次点击播放

### 3. 📁 每个调悬浮上传本地音频

**使用方法**:
1. 切换到"🎸 经典音频"伴奏模式
2. 在调性选择区域，**鼠标悬停**在任意调式按钮上（C, C#, D, ..., B）
3. 出现悬浮菜单，显示"📁 上传"按钮
4. 点击上传按钮，选择本地音频文件
5. 自动显示加载进度条
6. 加载完成后，该调显示绿色圆点标记

**支持格式**:
- MP3, WAV, OGG, M4A, FLAC 等所有浏览器支持的音频格式

**视觉反馈**:
- 🟢 **绿点标记**: 已预加载/已上传的调
- 🎯 **粉色高亮**: 当前选中的调
- ⚪ **灰色按钮**: 暂未配置音频的调

## 🎮 完整使用流程

### 方式一：使用预置音频
1. 进入和弦进行模式
2. 选择"🎸 经典音频"伴奏模式
3. 等待预加载完成（自动加载 A 调等预置音频）
4. 选择已有绿点的调（如 A 调）
5. 点击播放按钮开始练习

### 方式二：上传本地音频
1. 进入和弦进行模式
2. 选择"🎸 经典音频"伴奏模式
3. **悬停**在任意调式按钮上（如 C 调）
4. 点击"📁 上传"按钮
5. 选择本地音频文件（如 C-Blues.mp3）
6. 等待加载进度条到达 100%
7. 该调显示绿色圆点，表示已就绪
8. 点击播放按钮开始练习

## 🎯 技术实现细节

### 状态管理
```typescript
const [isAudioBackingLoading, setIsAudioBackingLoading] = useState(false);
const [loadingProgress, setLoadingProgress] = useState(0); // 0-100
const [loadingKeyName, setLoadingKeyName] = useState(''); // "A 调"
const [preloadedKeys, setPreloadedKeys] = useState<BackingTrackKey[]>([]);
```

### 加载流程
1. **读取文件**: `file.arrayBuffer()` → 20% 进度
2. **解码音频**: `audioContext.decodeAudioData()` → 50-100% 进度
3. **缓存音频**: 存入 `preloadedBuffers` Map
4. **更新状态**: 标记为已预加载

### 播放检查
```typescript
if (accompanimentMode === 'audio') {
  // 检查1: 调性是否可用
  if (!isTrackAvailable(audioBackingKey)) {
    alert('请选择其他调或上传本地音频');
    return;
  }
  
  // 检查2: 是否已预加载
  if (!isTrackPreloaded(audioBackingKey)) {
    alert('音频未加载，正在加载...');
    loadAudioBacking(audioBackingKey);
    return;
  }
  
  // 检查3: 是否正在加载
  if (isAudioBackingLoading) {
    alert('音频正在加载中，请稍候...');
    return;
  }
}
```

## 🎨 UI 组件说明

### 加载进度条组件
- **背景**: 黄色/橙色渐变，半透明
- **进度条**: 黄→橙→红渐变填充
- **光效**: 白色半透明光带循环扫过
- **文字**: 大号百分比 + 调名提示

### 调性选择组件
- **网格布局**: 6列，响应式
- **悬浮菜单**: 毛玻璃效果，粉色边框
- **上传按钮**: 蓝色半透明，悬停变亮
- **状态指示**: 绿点 = 已加载，粉色 = 当前调

## 📝 注意事项

1. **文件大小**: 建议音频文件不超过 10MB，避免加载时间过长
2. **音频格式**: 推荐使用 MP3 或 WAV 格式，兼容性最好
3. **BPM 匹配**: 上传的音频会自动适配当前 BPM 速度
4. **循环播放**: 音频会自动循环播放，配合和弦进行
5. **缓存机制**: 已加载的音频会保存在内存中，切换调性时无需重新加载

## 🔧 故障排除

**问题**: 点击播放没反应
- **检查**: 是否选择了有绿点的调
- **解决**: 悬停上传本地音频或选择其他已加载的调

**问题**: 加载进度卡住不动
- **检查**: 文件是否过大或格式不支持
- **解决**: 尝试使用 MP3 格式，文件大小 < 10MB

**问题**: 音频播放速度不对
- **检查**: BPM 设置是否合理
- **解决**: 调整 BPM 滑块，音频会自动适配速度

## 🎉 功能亮点

✅ **智能预加载**: 自动加载所有可用音频
✅ **进度可视化**: 实时显示加载进度和状态
✅ **本地上传**: 支持为每个调上传自定义音频
✅ **播放保护**: 多重检查确保音频就绪后才能播放
✅ **用户友好**: 清晰的提示和视觉反馈
✅ **性能优化**: 缓存机制避免重复加载

---

**更新时间**: 2025-01-07  
**版本**: v2.0.0
