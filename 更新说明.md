# 和弦进行 - 音频功能更新说明

## ✅ 已修复的问题

### 1. 📁 改为"选择音频文件"功能
**之前**: "上传"功能，容易误解为需要上传到服务器
**现在**: "选择音频文件"，直接从本地选择并加载

**说明**: 
- 所有音频文件都在本地处理，不会上传到服务器
- 选择文件后立即解码并缓存在浏览器内存中
- 适合只有部分调音频的场景（如只有 A 调）

### 2. 🖱️ 修复悬浮菜单鼠标移动问题
**问题**: 鼠标悬停在按钮上显示菜单，但移到菜单上时菜单消失
**原因**: 菜单的 `pointer-events-none` 导致鼠标事件穿透
**解决**: 在内层 div 添加 `pointer-events-auto`，确保菜单可以接收鼠标事件

**技术实现**:
```tsx
{/* 外层：默认 pointer-events-none，悬浮时 pointer-events-auto */}
<div className="... pointer-events-none group-hover:pointer-events-auto">
  {/* 内层：强制 pointer-events-auto，确保菜单可交互 */}
  <div className="... pointer-events-auto">
    <label>选择音频文件</label>
  </div>
</div>
```

## 🎨 视觉优化

### 按钮状态
- 🎯 **当前选中**: 粉色高亮 + 阴影
- 🟢 **已加载**: 绿色背景 + 绿点标记
- ⚪ **未加载**: 灰色半透明背景

### 悬浮菜单
- 毛玻璃效果背景
- 粉色边框
- 显示调名和加载状态
- 蓝色"选择音频文件"按钮

## 📝 使用流程

### 场景：只有 A 调音频

1. **切换模式**: 选择"🎸 经典音频"伴奏模式
2. **等待预加载**: 系统自动加载 A 调（如果有预置）
3. **选择 A 调**: 点击 A 调按钮（绿色背景）
4. **开始播放**: 点击播放按钮

### 场景：为其他调添加音频

1. **悬停按钮**: 鼠标悬停在 C 调按钮上
2. **保持悬停**: 鼠标移到弹出的菜单上（菜单不会消失）
3. **选择文件**: 点击"📁 选择音频文件"
4. **等待加载**: 观察进度条到达 100%
5. **切换调性**: C 调变为绿色，可以点击选择

## 🔧 技术细节

### 文件处理流程
1. 用户选择文件 → `<input type="file">`
2. 读取文件 → `file.arrayBuffer()`
3. 解码音频 → `audioContext.decodeAudioData()`
4. 缓存音频 → `preloadedBuffers.set(key, buffer)`
5. 更新状态 → 显示绿点标记

### 内存管理
- 音频缓存在 `Map<BackingTrackKey, AudioBuffer>`
- 切换调性时无需重新加载
- 关闭页面时自动释放内存

## 💡 使用建议

1. **文件格式**: 推荐 MP3 或 WAV
2. **文件大小**: 建议 < 10MB
3. **音频质量**: 128-320kbps 即可
4. **BPM 匹配**: 系统会自动调整播放速度

## 🎉 功能特点

✅ **纯本地处理**: 所有音频在浏览器中处理，无需服务器
✅ **即选即用**: 选择文件后立即可用
✅ **智能缓存**: 已加载的音频保存在内存中
✅ **视觉反馈**: 清晰的加载状态和调性标记
✅ **交互优化**: 悬浮菜单可以正常使用

---

**更新时间**: 2025-01-07  
**版本**: v2.1.0
